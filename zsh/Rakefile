$LOAD_PATH.unshift(File.join(File.dirname(__FILE__), "..", "lib"))

require "pathname"
require "rake/clean"
require "dotfiles/tasks"

dotzshrc = File.join(ENV["HOME"], ".zshrc")

CLEAN.include("zshrc", "*.patch")

FILES  = FileList["zshrc"]
BACKUP = FILES # so will consider everything as editable file

desc "Build all the files to the one big zshrc"
file "zshrc" => (FileList["**/*.sh"] - ["zshrc"]) do
  puts "Generating zshrc ..."
  files = FileList["{setup,functions,aliases,completion,environment,prompt}/**/*.sh"]
  if File.exist?("platforms/#{platform}.sh")
    files.push "platforms/#{platform}.sh"
  else
    warn "There is no platform file for you platform (expected platforms/#{platform}.sh)"
  end
  File.open("zshrc", "w") do |output|
    output.puts("source /etc/profile")
    files.each do |file|
      filename = Pathname.new(File.expand_path(file)).relative_path_from(Pathname.new(File.expand_path(Dir.pwd)))
      output.puts("### #{filename.to_s.upcase} ###")
      output.puts(File.read(file))
      output.puts
    end
  end
end

# register zshrc generation
task :preinstall => "zshrc"
